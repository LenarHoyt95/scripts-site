<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mes scripts â€” Ghislain</title>
  <meta name="description" content="BibliothÃ¨que personnelle de scripts avec recherche, tags et copie en un clic." />
  <style>
    :root {
      --bg: #0b1020;
      --panel: #111831;
      --muted: #8aa0c6;
      --text: #e8eefc;
      --accent: #6ea8fe;
      --accent-2: #9bffd6;
      --danger: #ff7878;
      --border: #23325a;
      --chip: #1a2342;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, 'Helvetica Neue', Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, var(--bg), #0d1326 50%, var(--bg));
      color: var(--text);
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    header { display: flex; gap: 16px; flex-wrap: wrap; align-items: center; justify-content: space-between; }
    .title { font-size: clamp(24px, 4vw, 36px); font-weight: 800; letter-spacing: 0.3px; }
    .subtitle { color: var(--muted); margin-top: 4px; font-size: 14px; }

    .toolbar { display: grid; grid-template-columns: 1fr 220px 160px; gap: 12px; margin-top: 16px; }
    .toolbar > * { width: 100%; }

    input, select {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 10px 12px;
      border-radius: 12px;
      outline: none;
    }
    input::placeholder { color: #9bb0d8; }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px; margin-top: 18px; }
    .card {
      background: linear-gradient(180deg, var(--panel), #0f1731);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      display: flex; flex-direction: column; gap: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
    }
    .card h3 { margin: 0; font-size: 16px; letter-spacing: .2px; }
    .meta { display: flex; gap: 8px; align-items: center; color: var(--muted); font-size: 12px; }
    .chip { background: var(--chip); border: 1px solid var(--border); color: #cfe0ff; padding: 3px 8px; border-radius: 999px; font-size: 11px; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; }

    .btnrow { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn {
      background: #16214a;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
    }
    .btn:hover { filter: brightness(1.1); }
    .btn.secondary { background: transparent; }
    .btn.danger { background: #2a0f16; border-color: #522129; color: #ffbcbc; }

    .code {
      position: relative;
      background: #0a0f24;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      overflow: auto;
      max-height: 50vh;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12.5px;
      line-height: 1.5;
      tab-size: 2;
      white-space: pre;
    }

    .footer { color: var(--muted); font-size: 12px; margin: 24px 0 8px; text-align: center; }
    .tagbar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .tagbar .chip { cursor: pointer; }
    .empty { color: var(--muted); text-align: center; padding: 24px; border: 1px dashed var(--border); border-radius: 16px; background: #0c1228; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <div class="title">ðŸ“š Mes scripts</div>
        <div class="subtitle">Recherche, tags, copie en 1 clic, tri par date â€” site statique prÃªt pour GitHub Pages.</div>
      </div>
      <div class="btnrow">
        <button class="btn" id="exportJsonBtn">Exporter Script</button>
        <label class="btn secondary" for="importJsonInput">Importer Script<input id="importJsonInput" type="file" accept="application/json" style="display:none" /></label>
        <button class="btn" id="addSampleBtn">+ Exemple</button>
      </div>
    </header>

    <div class="toolbar">
      <input id="q" placeholder="Rechercher (nom, description, code, tags)" />
      <select id="lang">
        <option value="">Langage : Tous</option>
      </select>
      <select id="sort">
        <option value="updated_desc">Trier : plus rÃ©cent</option>
        <option value="updated_asc">Trier : plus ancien</option>
        <option value="name_asc">Trier : nom Aâ†’Z</option>
        <option value="name_desc">Trier : nom Zâ†’A</option>
      </select>
    </div>

    <div id="tagBar" class="tagbar"></div>

    <section id="grid" class="grid" aria-live="polite"></section>

    <p class="footer">Astuce : hÃ©berge ce dossier sur GitHub Pages. Tout est horsâ€‘ligne, tes donnÃ©es restent dans <code>localStorage</code> et tu peux aussi importer/exporter un JSON.</p>
  </div>

  <script>
    /**
     * Stockage
     * - Les scripts sont conservÃ©s dans localStorage (clÃ©: scriptsLibrary_v1)
     * - Tu peux aussi exporter/importer en JSON pour versionner sur Git/GitHub.
     */
    const STORAGE_KEY = 'scriptsLibrary_v1';

    /** Type ScriptItem
     * {
     *   id: string,
     *   name: string,
     *   language: string,      // ex: 'Google Apps Script', 'VBA', 'Bash', 'PowerShell', 'Python'
     *   description: string,
     *   tags: string[],
     *   updatedAt: string,     // ISO date
     *   code: string,
     *   link?: string          // lien vers dÃ©pÃ´t / gist / sheet
     * }
     */

    const $ = (sel) => document.querySelector(sel);
    const grid = $('#grid');
    const q = $('#q');
    const lang = $('#lang');
    const sort = $('#sort');
    const tagBar = $('#tagBar');

    const readStore = () => {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
      catch { return []; }
    };
    const writeStore = (arr) => localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));

    function uniq(arr) { return [...new Set(arr)]; }

    function allTags(items) { return uniq(items.flatMap(i => i.tags || []).map(t => t.trim()).filter(Boolean)).sort((a,b)=>a.localeCompare(b)); }

    function renderTagBar(items) {
      const tags = allTags(items);
      tagBar.innerHTML = '';
      if (!tags.length) return;
      const active = new Set((new URLSearchParams(location.search).get('tags')||'').split(',').filter(Boolean));
      tags.forEach(t => {
        const el = document.createElement('span');
        el.className = 'chip';
        el.textContent = `#${t}`;
        el.dataset.tag = t;
        if (active.has(t)) el.style.outline = '2px solid var(--accent)';
        el.addEventListener('click', () => toggleTag(t));
        tagBar.appendChild(el);
      });
    }

    function toggleTag(tag) {
      const params = new URLSearchParams(location.search);
      const set = new Set((params.get('tags')||'').split(',').filter(Boolean));
      set.has(tag) ? set.delete(tag) : set.add(tag);
      params.set('tags', [...set].join(','));
      history.replaceState({}, '', `${location.pathname}?${params.toString()}`);
      refresh();
    }

    function copy(text) {
      navigator.clipboard.writeText(text).then(()=>{
        toast('CopiÃ© dans le presseâ€‘papiers');
      }).catch(()=>{
        alert('Copie impossible');
      });
    }

    function toast(msg) {
      const t = document.createElement('div');
      t.textContent = msg;
      t.style.position = 'fixed';
      t.style.bottom = '16px';
      t.style.left = '50%';
      t.style.transform = 'translateX(-50%)';
      t.style.background = 'rgba(20,30,70,0.95)';
      t.style.border = '1px solid var(--border)';
      t.style.padding = '10px 14px';
      t.style.borderRadius = '999px';
      t.style.zIndex = 9999;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 1400);
    }

    function humanDate(iso) {
      try { return new Date(iso).toLocaleDateString('fr-FR', { year:'numeric', month:'short', day:'2-digit' }); }
      catch { return iso; }
    }

    function render(items) {
      const params = new URLSearchParams(location.search);
      const activeTags = new Set((params.get('tags')||'').split(',').filter(Boolean));
      const term = (q.value||'').toLowerCase();
      const langVal = lang.value;
      const sortVal = sort.value;

      let filtered = items.filter(it => {
        if (langVal && it.language !== langVal) return false;
        if (activeTags.size && ![...activeTags].every(t => (it.tags||[]).includes(t))) return false;
        if (!term) return true;
        const hay = [it.name, it.language, it.description, (it.tags||[]).join(' '), it.code].join(' \n ').toLowerCase();
        return hay.includes(term);
      });

      switch (sortVal) {
        case 'updated_asc': filtered.sort((a,b)=>new Date(a.updatedAt)-new Date(b.updatedAt)); break;
        case 'name_asc': filtered.sort((a,b)=>a.name.localeCompare(b.name)); break;
        case 'name_desc': filtered.sort((a,b)=>b.name.localeCompare(a.name)); break;
        default: filtered.sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));
      }

      grid.innerHTML = '';
      if (!filtered.length) {
        grid.innerHTML = `<div class="empty">Aucun rÃ©sultat. Essaie d'enlever des tags ou de modifier la recherche.</div>`;
        return;
      }

      filtered.forEach(it => {
        const card = document.createElement('article');
        card.className = 'card';

        const title = document.createElement('h3');
        title.textContent = it.name;
        card.appendChild(title);

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `<span class="chip">${it.language}</span><span>â€¢</span><span>Maj ${humanDate(it.updatedAt)}</span>${it.link?`<span>â€¢</span><a href="${it.link}" target="_blank" rel="noopener" style="color: var(--accent)">Lien</a>`:''}`;
        card.appendChild(meta);

        if (it.description) {
          const p = document.createElement('p');
          p.style.margin = '4px 0 0 0';
          p.style.color = 'var(--muted)';
          p.textContent = it.description;
          card.appendChild(p);
        }

        if (it.tags?.length) {
          const chips = document.createElement('div');
          chips.className = 'chips';
          it.tags.forEach(t=>{
            const c = document.createElement('span');
            c.className = 'chip';
            c.textContent = `#${t}`;
            c.addEventListener('click', ()=>toggleTag(t));
            chips.appendChild(c);
          });
          card.appendChild(chips);
        }

        const pre = document.createElement('pre');
        pre.className = 'code';
        pre.textContent = it.code;
        card.appendChild(pre);

        const row = document.createElement('div');
        row.className = 'btnrow';
        const b1 = document.createElement('button'); b1.className = 'btn'; b1.textContent = 'Copier le code'; b1.onclick = ()=>copy(it.code);
        const b2 = document.createElement('button'); b2.className = 'btn secondary'; b2.textContent = 'Copier le nom'; b2.onclick = ()=>copy(it.name);
        const b3 = document.createElement('button'); b3.className = 'btn secondary'; b3.textContent = 'Supprimer'; b3.onclick = ()=>removeItem(it.id);
        row.append(b1,b2,b3);
        card.appendChild(row);

        grid.appendChild(card);
      });
    }

    function rebuildLangFilter(items) {
      const langs = uniq(items.map(i=>i.language).filter(Boolean)).sort((a,b)=>a.localeCompare(b));
      lang.innerHTML = '<option value="">Langage : Tous</option>' + langs.map(l=>`<option>${l}</option>`).join('');
    }

    function refresh() {
      const items = readStore();
      renderTagBar(items);
      rebuildLangFilter(items);
      render(items);
    }

    function removeItem(id) {
      if (!confirm('Supprimer ce script ?')) return;
      const arr = readStore().filter(i=>i.id!==id);
      writeStore(arr);
      refresh();
    }

    function addItem(item) {
      const arr = readStore();
      const id = crypto.randomUUID();
      arr.unshift({ id, ...item, updatedAt: item.updatedAt || new Date().toISOString() });
      writeStore(arr);
      refresh();
    }

    // Import / Export JSON
    $('#exportJsonBtn').addEventListener('click', () => {
      const data = readStore();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'mes-scripts.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    $('#importJsonInput').addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const arr = JSON.parse(reader.result);
          if (!Array.isArray(arr)) throw new Error('format invalide');
          writeStore(arr);
          refresh();
          toast('Import rÃ©ussi');
        } catch (err) {
          alert('JSON invalide');
        }
      };
      reader.readAsText(file);
    });

    // Bouton d'exemple rapide
    $('#addSampleBtn').addEventListener('click', () => {
      addItem({
        name: 'Export Drive Tree (stylÃ© & groupÃ©)',
        language: 'Google Apps Script',
        description: 'Exporte l\'arborescence Drive dans un nouveau Google Sheet avec styles et regroupements, sans trier.',
        tags: ['drive', 'sheets', 'export', 'arbo'],
        link: '',
        code: `const BATCH_SIZE = 400;\nfunction exportDriveTreeStylish() {\n  const startFolderId = null;\n  const ss = SpreadsheetApp.create(\n    'Arbo (stylÃ©e & groupÃ©e) - ' + Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm')\n  );\n  const root = startFolderId ? DriveApp.getFolderById(startFolderId) : DriveApp.getRootFolder();\n  const shSummary = ss.getActiveSheet();\n  shSummary.setName('RÃ©sumÃ©');\n  // ... suite du script ...\n}`
      });
    });

    // PremiÃ¨re exÃ©cution
    refresh();

  </script>
</body>
</html>
